#!/bin/bash
# Use /config for debug log instead of /tmp (better permissions)
echo "Autostart running as: $(whoami)" > /config/autostart-debug.log

# Create runtime directory as root with proper ownership
mkdir -p /tmp/runtime-abc
chown abc:abc /tmp/runtime-abc
chmod 700 /tmp/runtime-abc

# Method 1: Try runuser first
if command -v runuser >/dev/null 2>&1; then
    echo "Using runuser method" >> /config/autostart-debug.log
    runuser -l abc -c '
    export DISPLAY=:1
    export XDG_RUNTIME_DIR=/tmp/runtime-abc
    export XDG_CONFIG_HOME=/config/.config
    export XDG_DATA_HOME=/config/.local/share  
    export XDG_CACHE_HOME=/config/.cache
    mkdir -p "$XDG_CONFIG_HOME" "$XDG_DATA_HOME" "$XDG_CACHE_HOME"
    firefox-esr --no-sandbox --disable-gpu-sandbox --disable-software-rasterizer ${FIREFOX_CLI}
    '
# Method 2: Fall back to s6-setuidgid
elif command -v s6-setuidgid >/dev/null 2>&1; then
    echo "Using s6-setuidgid method" >> /config/autostart-debug.log
    cd /config
    s6-setuidgid abc bash -c '
    export DISPLAY=:1
    export XDG_RUNTIME_DIR=/tmp/runtime-abc
    export XDG_CONFIG_HOME=/config/.config
    export XDG_DATA_HOME=/config/.local/share  
    export XDG_CACHE_HOME=/config/.cache
    mkdir -p "$XDG_CONFIG_HOME" "$XDG_DATA_HOME" "$XDG_CACHE_HOME"
    firefox-esr --no-sandbox --disable-gpu-sandbox --disable-software-rasterizer ${FIREFOX_CLI}
    '
else
    echo "ERROR: No suitable user switching method found" >> /config/autostart-debug.log
fi
